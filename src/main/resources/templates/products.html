<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Art Supplies Store</title>
    <link rel="stylesheet" type="text/css" href="/css/products.css">
    <link rel="stylesheet" th:href="@{/css/header-footer.css}">
</head>
<body class="products-page">
<!--<header>-->
<div th:replace="~{fragments/header :: header}"></div>
<main class="product-page">
    <div class="search-filter-container">
        <input type="text" id="search-bar" placeholder="Search products..." oninput="searchProducts()">
        <select id="filter-dropdown" onchange="filterProducts()">
            <option value="">All Types</option>
            <option th:each="category : ${categories}" th:value="${category.categoryName}" th:text="${category.categoryName}"></option>
        </select>
    </div>
    <div class="product-container" id="product-container">
        <div class="product-card" th:each="product : ${products}" th:data-type="${product.category.categoryName}" th:data-description="${product.description}">
            <img th:src="${product.image}" alt="Product Image">
            <h2 th:text="${product.productName}"></h2>
            <p>Price: $<span th:text="${product.price}"></span></p>
            <div class="button-container">
                <a class="product-details" th:href="@{/products/show/{productId}(productId=${product.productId})}">View Details</a>
                <form class="add-to-cart-form" th:action="@{/cart/add}" method="post" sec:authorize="isAuthenticated()">
                    <input type="hidden" name="productId" th:value="${product.productId}">
                    <input type="number" name="quantity" value="1" min="1">
                    <button type="submit">Add to Cart</button>
                </form>
            </div>
            <div sec:authorize="!isAuthenticated()">
                <p>Please <a th:href="@{/login}">login</a> to add products to cart</p>
            </div>
        </div>
    </div>
</main>
<!--<footer>-->
<div th:replace="~{fragments/footer :: footer}"></div>
<script>
    function searchProducts() {
        const searchTerm = document.getElementById('search-bar').value.toLowerCase();
        const url = searchTerm ? `/products/search?keyword=${searchTerm}` : '/products/all';

        fetch(url)
            .then(response => response.json())
            .then(products => {
                const productContainer = document.getElementById('product-container');
                productContainer.innerHTML = '';
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.setAttribute('data-type', product.category.categoryName);
                    productCard.setAttribute('data-description', product.description);
                    productCard.innerHTML = `
                        <img src="${product.image}" alt="Product Image">
                        <h2>${product.productName}</h2>
                        <p>Price: $<span>${product.price}</span></p>
                        <div class="button-container">
                            <a class="product-details" href="/products/show/${product.productId}">View Details</a>
                            <button>Add to Cart</button>
                        </div>
                    `;
                    productContainer.appendChild(productCard);
                });
            });
    }

    function filterProducts() {
        const filterValue = document.getElementById('filter-dropdown').value.toLowerCase();
        fetch(`/products/filter?categoryName=${filterValue}`)
            .then(response => response.json())
            .then(products => {
                const productContainer = document.getElementById('product-container');
                productContainer.innerHTML = '';
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.setAttribute('data-type', product.category.categoryName);
                    productCard.setAttribute('data-description', product.description);
                    productCard.innerHTML = `
                        <img src="${product.image}" alt="Product Image">
                        <h2>${product.productName}</h2>
                        <p>Price: $<span>${product.price}</span></p>
                        <div class="button-container">
                            <a class="product-details" href="/products/show/${product.productId}">View Details</a>
                            <button>Add to Cart</button>
                        </div>
                    `;
                    productContainer.appendChild(productCard);
                });
            });
    }
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('.add-to-cart-form');
        forms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(form);
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            alert('Product added to cart!');
                        } else {
                            alert('Failed to add product to cart.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    });
            });
        });
    });
</script>
</body>
</html>